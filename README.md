# IoT Individual assingment
#### Lorenzo Frangella ID 1899674
---
This GitHub repository contains the code for the individual assignment of IoT Algorithms and Services.
The project is composed by the following parts:

1. Signal Generation code
2. Code for the ESP32 to sample the signal, adjust the frequency and send messages.
3. Arduino code for a ESP8266 to measure the power used by the ESP32 while sampling.
4. Some evaluations over the power consumtions based on the sampling frequency

---

## How to execute the project

#### Signal Generation

The first step needed is to generate a signal, in this project signal is generated by a python script as audio output.
With that script is possible to generate a signal as a sum of multiple sinusoid functions given by the formula:
$$\sum_{k=1}^n a_k sin(2\pi t f_k+ \phi_k)$$
Below an example of a signal generated with the sum of the following sinusoids:

    a = [7,8,5]     f = [2,6,10]    phase = [0.6,0,0.2]

![alt text](img/plots/signal_plot.png)

Once the signal is generated it is played from the pc, and thanks to a [circuit](https://forum.arduino.cc/t/how-to-read-data-from-audio-jack/458301/3) the signal can be passed to a GPIO pin
of the ESP32 where is possible to sample (an ADC pin). 

---

#### Signal Sampling
The code for the ESP32 can be found in the folder "esp-code" wich is structured as the following.

    esp-code
        |
        |->main
            | -> main.c         ---->   File containing the code executed on startup 
            | -> fft_config.h   ---->   File to setup the fft
            | -> mqtt.h         ---->   File to use mqtt
            | -> sampling.h     ---->   File for sampling task
            | -> sender.h       ---->   File for sampling task
            | -> structs.h      ---->   Data structures to pass arguments to tasks
            | -> wifi.h         ---->   File to use wifi

Code can be built and flashed in the esp by entering in the folder "eps-code" and run

    idf.py build flash monitor

To setup the parameters needed to make the project run is necessary to enter into menuconfig, 
in the menu Sampling configuration and set:
    
    (1000) Set the default sampling frequency in Hz                                                     
    (1) Decide to run or not the fft to adjust in an adaptive manner the sampling frequency             
    (5) Threshold value for the Z score, to identify outliers                                           
    (mqtt server address) Set the server address for mqtt                                               
    (mqtt topic) Set the topic to where publish messages                                                
    (wifi ssid) WIFI SSID                                                                               
    (wifi password) WIFI PASSWORD

Also another parameter in menuconfig must be changed:

    Component config -> FreeRTOS -> Kernel -> ConfigTICK_RATE_HZ

By default the value of this parameter is setted to 100. This means that the clock tick resolution of
FreeRTOS is 100Hz. The problem is that in this project to adjust the frequency of sampling to values 
higher than 100Hz is not possible using vTaskDelay() function, since this function takes as input the 
number of ticks to wait to restart. Increasing this parameter to its maximum (1000) allows to sample
up to 1kHz.

Sampling at higher rates is still possible but not trivial, the easiest way to sample at higher frequency
is to sample at maximum ADC frequency which is 2MHz. Then we will see drawbacks of sampling at this rates.

---

#### FFT execution

    